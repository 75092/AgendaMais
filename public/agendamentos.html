<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<title>Agendamentos</title>
<link href="style.css" rel="stylesheet"/>
<style>
    .input-estilo {
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #aaa;
      border-radius: 5px;
      box-sizing: border-box;
      margin: 5px 0 15px 0;
    }
    .input-email { width: 250px; }
    .input-contacto { width: 160px; }
    .input-participantes { width: 120px; }
    label { display: block; }
    textarea {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #aaa;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .popup-confirmacao {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #4CAF50;
      color: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      font-size: 1.2rem;
      z-index: 9999;
      text-align: center;
      animation: fadeOut 30s forwards;
    }
    @keyframes fadeOut {
      0% {opacity: 1;} 80% {opacity: 1;} 100% {opacity: 0; display: none;}
    }
    #tabela-semanal {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-family: Arial, sans-serif;
      font-size: 0.95rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    #tabela-semanal th, #tabela-semanal td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    #tabela-semanal thead { background-color: #f4f4f4; font-weight: bold; }
    #tabela-semanal tbody tr:nth-child(even) { background-color: #fafafa; }
    #tabela-semanal tbody tr:hover { background-color: #f1f1f1; }
  
    fieldset#recursos label {
      display: block;
      margin-bottom: 8px;
    }
</style>
<script src="auth.js"></script>
</head>
<body>
<style>
  #logout-btn {
    position: fixed;
    top: 15px;
    right: 20px;
    padding: 8px 14px;
    background-color: #e74c3c;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    z-index: 2000;
    display: none;
  }
</style>
<button id="logout-btn" onclick="logout()">Logout</button>
<script>
  ensureAuthenticated();
  showLogoutIfAuthenticated();

  function logout() {
    localStorage.removeItem("token");
    window.location.href = "/login.html";
  }
</script>

<div class="header">
<img alt="Logotipo ULSAS" class="logo" src="/ulsas_logotipo.png"/>
</div>
<div class="sidebar">
<ul>
<li><a href="index.html">Início</a></li>
<li><a href="agendamentos.html">Agendamentos</a></li>
<li><a href="calendario.html">Calendário</a></li>
<li><a href="salas.html">Salas</a></li>
<li><a href="admin.html">Administração</a></li>
</ul>
</div>

<div class="main-content">
<h1>Agendamentos</h1>
<a class="botao-novo" href="#" onclick="abrirModal()">+ Novo Agendamento</a>

<h2>Agendamentos da Semana</h2>
<label for="filtroSala"><strong>Filtrar por Sala:</strong></label>
<select class="input-estilo input-sala" id="filtroSala" onchange="mostrarAgendamentosSemana()">
  <option value="todas">Ver Todas</option>

  <optgroup label="HGO">
    <option>HGO - Sala Almada</option>
    <option>HGO - Sala Garcia de Orta</option>
    <option>HGO - Sala Tejo</option>
    <option>HGO - Sala Almada + Garcia de Orta</option>
  </optgroup>

  <optgroup label="CF Sobreda">
    <option>CF Sobreda - Auditório Dr. Luís Amaro</option>
    <option>CF Sobreda - Sala Sado</option>
    <option>CF Sobreda - Sala Tejo</option>
  </optgroup>

  <optgroup label="CF Amora">
    <option>CF Amora - Sala Amora</option>
  </optgroup>
</select>

<table id="tabela-semanal">
<thead>
<tr>
<th>Data</th>
<th>Hora Início</th>
<th>Hora Fim</th>
<th>Sala</th>
<th>Evento</th>
<th>Participantes</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="modalAgendamento">
<div class="modal-content">
<span class="fechar" onclick="fecharModal()">×</span>
<h2>Novo Agendamento</h2>
<form id="form-agendamento">
<fieldset>
<legend><strong>Requerente</strong></legend>
<label>Número Mecanográfico:<br/><input id="numMec" required type="text"/></label><br/>
<label>Nome do Requerente:<br/><input id="nomeReq" required type="text"/></label><br/>
<label>Serviço do Requerente:<br/><input id="servicoReq" required type="text"/></label><br/>
<label>E-mail:<br/><input id="emailReq" required type="email"/></label><br/>
<label>Contacto:<br/><input id="contactoReq" required type="tel"/></label><br/>
</fieldset><br/>

<fieldset>
<legend><strong>Data e Hora</strong></legend>
<label>Data:<br/><input id="data" onchange="atualizarSalasDisponiveis()" required type="date"/></label><br/>
<label>Hora Início:<br/><input id="horaInicio" onchange="atualizarSalasDisponiveis()" required type="time"/></label><br/>
<label>Hora Fim:<br/><input id="horaFim" onchange="atualizarSalasDisponiveis()" required type="time"/></label><br/>
</fieldset><br/>

<fieldset>
<legend><strong>Evento</strong></legend>
<label>Sala:<br/><select id="sala" required></select></label><br/>
<label>Tipo de Evento:<br/>
<select class="input-estilo" id="tipoEvento" required>
<option value="">-- Selecione --</option>
<option value="Reuniões clínicas">Reuniões clínicas</option>
<option value="Reuniões Entidades Externas">Reuniões Entidades Externas</option>
<option value="Concursos e Exames">Concursos e Exames</option>
<option value="Formação em Serviço">Formação em Serviço</option>
<option value="Auditoria">Auditoria</option>
<option value="Reunião de Comissão">Reunião de Comissão</option>
<option value="Formação para Utentes">Formação para Utentes</option>
</select>
</label><br/>
<label>Nome do Evento:<br/><input id="nomeEvento" required type="text"/></label><br/>
<label>Participantes:<br/><input id="participantes" type="number"/></label><br/>
</fieldset><br/>

<fieldset id="recursos">
<legend><strong>Recursos</strong></legend>
<label><input name="recursos" type="checkbox" value="Projetor"/> Projetor</label>
<label><input name="recursos" type="checkbox" value="Computador"/> Computador</label>
<label><input name="recursos" type="checkbox" value="Áudio"/> Áudio</label>
<label><input name="recursos" type="checkbox" value="Ponteiro"/> Ponteiro</label>
<label><input name="recursos" type="checkbox" value="Coffee break"/> Coffee break</label>
</fieldset><br/>

<fieldset>
<legend><strong>Observações</strong></legend>
<textarea id="observacoes" placeholder="Escreva aqui.." rows="4"></textarea>
</fieldset><br/>

<button class="botao-novo" onclick="guardarAgendamento()" type="button">Submeter</button>
</form>
</div>
</div>

<div class="popup-confirmacao" id="popupConfirmacao">
<p>O seu pedido foi submetido com sucesso<br/>Aguarde e-mail de confirmação<br/>Obrigado</p>
</div>
</div>

<script>
function abrirModal() {
  document.getElementById('modalAgendamento').style.display = 'block';
}

function fecharModal() {
  document.getElementById('modalAgendamento').style.display = 'none';
}

function guardarAgendamento() {
  const nomeEvento = document.getElementById("nomeEvento").value;
  const data = document.getElementById("data").value;
  const horaInicio = document.getElementById("horaInicio").value;
  const horaFim = document.getElementById("horaFim").value;
  const sala = document.getElementById("sala").value;
  const participantes = document.getElementById("participantes").value;
  const observacoes = document.getElementById("observacoes").value;

  const numMec = document.getElementById("numMec").value;
  const nomeReq = document.getElementById("nomeReq").value;
  const servicoReq = document.getElementById("servicoReq").value;
  const emailReq = document.getElementById("emailReq").value;
  const contactoReq = document.getElementById("contactoReq").value;

  const recursos = Array.from(document.querySelectorAll('input[name="recursos"]:checked')).map(e => e.value);

  if (!nomeEvento || !data || !horaInicio || !horaFim || !sala || !nomeReq || !emailReq || !numMec || !servicoReq || !contactoReq) {
    alert("Preencha todos os campos obrigatórios.");
    return;
  }

  if (horaFim <= horaInicio) {
    alert("A hora de fim deve ser posterior à de início.");
    return;
  }

  const agendamentos = JSON.parse(localStorage.getItem("agendamentos") || "[]");

  const conflito = agendamentos.some(a =>
    a.extendedProps?.sala === sala &&
    a.start.startsWith(data) &&
    (
      (horaInicio >= a.start.slice(11, 16) && horaInicio < a.end.slice(11, 16)) ||
      (horaFim > a.start.slice(11, 16) && horaFim <= a.end.slice(11, 16)) ||
      (horaInicio <= a.start.slice(11, 16) && horaFim >= a.end.slice(11, 16))
    )
  );

  if (conflito) {
    alert("Já existe um agendamento para esta sala nesse horário.");
    return;
  }

  const tipoEvento = document.getElementById("tipoEvento").value;
  agendamentos.push({
    title: tipoEvento + " - " + nomeEvento + " - " + sala,
    start: `${data}T${horaInicio}`,
    end: `${data}T${horaFim}`,
    extendedProps: {
      sala, participantes, observacoes, status: "em_aprovacao",
      numMec, nomeReq, servicoReq, emailReq, contactoReq, recursos
    }
  });

  localStorage.setItem("agendamentos", JSON.stringify(agendamentos));

  document.getElementById("popupConfirmacao").style.display = "block";
  setTimeout(() => {
    document.getElementById("popupConfirmacao").style.display = "none";
  }, 5000);

  document.getElementById("form-agendamento").reset();
  fecharModal();
  mostrarAgendamentosSemana();
}

function atualizarSalasDisponiveis() {
  const data = document.getElementById("data").value;
  const inicio = document.getElementById("horaInicio").value;
  const fim = document.getElementById("horaFim").value;
  if (!data || !inicio || !fim) return;

  const agendamentos = JSON.parse(localStorage.getItem("agendamentos") || "[]");
  const salas = [
    "HGO - Sala Almada",
    "HGO - Sala Garcia de Orta",
    "HGO - Sala Tejo",
    "HGO - Sala Almada + Garcia de Orta",
    "CF Sobreda - Auditório Dr. Luís Amaro",
    "CF Sobreda - Sala Sado",
    "CF Sobreda - Sala Tejo",
    "CF Amora - Sala Amora"
  ];
  const ocupadas = new Set();

  const inicioSel = new Date(`${data}T${inicio}`);
  const fimSel = new Date(`${data}T${fim}`);

  agendamentos.forEach(ev => {
    const inicioEv = new Date(ev.start);
    const fimEv = new Date(ev.end);
    if (ev.start.startsWith(data) && fimSel > inicioEv && inicioSel < fimEv) {
      ocupadas.add(ev.extendedProps?.sala);
    }
  });

  const select = document.getElementById("sala");
  select.innerHTML = '<option value="">-- Selecione --</option>';
  salas.forEach(s => {
    if (!ocupadas.has(s)) {
      select.innerHTML += `<option>${s}</option>`;
    }
  });
}

function mostrarAgendamentosSemana() {
  const tabela = document.querySelector("#tabela-semanal tbody");
  const agendamentos = JSON.parse(localStorage.getItem("agendamentos") || "[]");

  const hoje = new Date();
  const inicioSemana = new Date(hoje);
  inicioSemana.setDate(hoje.getDate() - (hoje.getDay() === 0 ? 6 : hoje.getDay() - 1));
  inicioSemana.setHours(0, 0, 0, 0);
  const fimSemana = new Date(inicioSemana);
  fimSemana.setDate(inicioSemana.getDate() + 6);
  fimSemana.setHours(23, 59, 59, 999);

  const salaSelecionada = document.getElementById("filtroSala")?.value || "todas";
  const eventos = agendamentos.filter(ev => {
    const inicio = new Date(ev.start);
    return inicio >= inicioSemana && inicio <= fimSemana &&
           (salaSelecionada === "todas" || ev.extendedProps?.sala === salaSelecionada);
  });

  tabela.innerHTML = "";
  eventos.forEach(ev => {
    const inicio = new Date(ev.start);
    const fim = new Date(ev.end);
    tabela.innerHTML += `
      <tr>
        <td>${inicio.toLocaleDateString()}</td>
        <td>${inicio.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
        <td>${fim.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
        <td>${ev.extendedProps?.sala || ""}</td>
        <td>${ev.title.split(" - ")[0]}</td>
        <td>${ev.extendedProps?.participantes || ""}</td>
      </tr>`;
  });
}

document.addEventListener("DOMContentLoaded", mostrarAgendamentosSemana);

document.addEventListener("DOMContentLoaded", function () {
  const dataInput = document.getElementById("data");
  const hoje = new Date();
  hoje.setDate(hoje.getDate() + 1); // amanhã
  const ano = hoje.getFullYear();
  const mes = String(hoje.getMonth() + 1).padStart(2, '0');
  const dia = String(hoje.getDate()).padStart(2, '0');
  dataInput.min = `${ano}-${mes}-${dia}`;
});

try {
  const payload = getTokenPayload();
  if (payload?.role !== "admin") {
    const adminLink = document.querySelector('a[href="admin.html"]');
    if (adminLink) adminLink.style.display = "none";
  }
} catch (e) {}
</script>
</body>
</html>
