<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<title>Administração</title>
<link href="style.css" rel="stylesheet"/>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9;}
  .sidebar { width:220px; background:#2d6a4f; position:fixed; top:0; bottom:0; padding:1em 0; color:white; }
  .sidebar ul { list-style:none; padding:0; }
  .sidebar ul li { margin:10px 0; }
  .sidebar ul li a { color:white; text-decoration:none; padding:8px 16px; display:block; }
  .sidebar ul li a:hover { background:#1b4332; }
  .main-content { margin-left:240px; padding:20px; }

  h1 { margin-top:0; }

  .tabs { margin-bottom:1em; }
  .tab-button { padding:10px 15px; margin-right:5px; border:none; background:#eee; cursor:pointer; border-radius:5px; }
  .tab-button.active { background:#ccc; }
  .tab-content { display:none; padding:1em; background:#fff; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .tab-content.active { display:block; }

  .sub-tabs { margin-top:1em; }
  .sub-tab-button { padding:8px 12px; margin-right:5px; border:none; background:#007bff; color:white; cursor:pointer; border-radius:5px; }
  .sub-tab-button.active { background:#0056b3; }
  .sub-tab-content { display:none; margin-top:1em; }
  .sub-tab-content.active { display:block; }

  .agendamento-card { background:#fafafa; border-radius:8px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:15px; }
  .agendamento-card button { margin-top:10px; margin-right:8px; padding:6px 10px; border:none; border-radius:5px; background-color:#2b7cff; color:white; cursor:pointer; }
  .agendamento-card button:hover { background-color:#195ecb; }

  #logout-btn { position:fixed; top:15px; right:20px; padding:8px 14px; background-color:#e74c3c; color:white; border:none; border-radius:5px; cursor:pointer; z-index:2000; display:none; }

  .popup-confirmacao { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#4CAF50; color:white; padding:20px 30px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.4); z-index:9999; }
</style>

<script src="auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
<div class="sidebar">
  <ul>
    <li><a href="index.html">Início</a></li>
    <li><a href="agendamentos.html">Agendamentos</a></li>
    <li><a href="calendario.html">Calendário</a></li>
    <li><a href="salas.html">Salas</a></li>
    <li><a href="admin.html">Administração</a></li>
  </ul>
</div>

<div class="main-content">
  <h1>Administração</h1>

  <div style="margin-bottom:1em;">
    <label for="filtro-data"><strong>Filtrar por data:</strong></label>
    <input id="filtro-data" type="date"/>
    <button onclick="document.getElementById('filtro-data').value=''; render();">Limpar filtro</button>
  </div>

  <div class="tabs">
    <button class="tab-button active" data-tab="aprovacao">Aprovado</button>
    <button class="tab-button" data-tab="pendente">Pendente</button>
    <button class="tab-button" data-tab="reservas">Reservas</button>
    <button class="tab-button" data-tab="concluido">Concluído</button>
    <button class="tab-button" data-tab="definicoes">Definições</button>
  </div>

  <div id="aprovacao" class="tab-content active"></div>
  <div id="pendente" class="tab-content"></div>
  <div id="reservas" class="tab-content"></div>
  <div id="concluido" class="tab-content">
    <label><strong>Filtrar por sala:</strong></label>
    <select id="filtro-concluido" onchange="render()">
      <option value="todas">Todas as salas</option>
      <option value="hgo">Salas HGO</option>
      <option value="sobreda">Salas Sobreda</option>
    </select>
    <div id="lista-concluido"></div>
  </div>

  <div id="definicoes" class="tab-content">
    <div class="sub-tabs">
      <button class="sub-tab-button active" data-subtab="ocupacao">Taxa de Ocupação</button>
      <button class="sub-tab-button" data-subtab="noticias">Gestão de Notícias</button>
    </div>

    <div id="ocupacao" class="sub-tab-content active">
      <h3>Taxa de Ocupação</h3>
      <label for="ocupacao-sala">Sala:</label>
      <select id="ocupacao-sala">
        <option value="todas">Todas</option>
        <option value="hgo">Todas as salas HGO</option>
        <option value="sobreda">Todas as salas Sobreda</option>
        <option value="Sala Almada">Sala Almada</option>
        <option value="Sala Tejo (HGO)">Sala Tejo (HGO)</option>
        <option value="Sala Tejo (Sobreda)">Sala Tejo (Sobreda)</option>
        <option value="Sala Garcia de Orta">Sala Garcia de Orta</option>
        <option value="Sala Sado">Sala Sado</option>
        <option value="Sala Auditório">Sala Auditório</option>
      </select>
      <label for="ocupacao-ano">Ano:</label>
      <select id="ocupacao-ano"></select>
      <button onclick="calcularTaxaOcupacao()">Calcular</button>
      <button onclick="exportarParaExcel()">Exportar para Excel</button>
      <div id="resultado-ocupacao"></div>
    </div>

    <div id="noticias" class="sub-tab-content">
      <h3>Gestão de Notícias</h3>
      <form id="noticiaForm">
        <label for="titulo">Título</label><br/>
        <input type="text" id="titulo" required/><br/><br/>
        <label for="conteudo">Conteúdo</label><br/>
        <textarea id="conteudo" required></textarea><br/><br/>
        <button type="submit">Adicionar Notícia</button>
      </form>
      <div class="news-list" id="listaNoticias"></div>
    </div>
  </div>
</div>

<button id="logout-btn" onclick="logout()">Logout</button>
<div class="popup-confirmacao" id="popupEmailConfirmado"><p>Email enviado com sucesso!</p></div>

<script>
// Tabs principais
document.querySelectorAll(".tab-button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// Sub-tabs
document.querySelectorAll(".sub-tab-button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".sub-tab-button").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".sub-tab-content").forEach(c => c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.subtab).classList.add("active");
  });
});

// Gestão de Notícias
async function carregarNoticias() {
  try {
    const res = await fetch("noticias.json");
    if (!res.ok) throw new Error("Erro ao carregar");
    const noticias = await res.json();
    const lista = document.getElementById("listaNoticias");
    lista.innerHTML = "";
    noticias.forEach((n, i) => {
      const div = document.createElement("div");
      div.className = "news-item";
      div.innerHTML = `<strong>${n.titulo}</strong><p>${n.conteudo}</p><button onclick="removerNoticia(${i})">Remover</button>`;
      lista.appendChild(div);
    });
  } catch (e) { console.error(e); }
}

document.getElementById("noticiaForm").addEventListener("submit", async e => {
  e.preventDefault();
  const titulo = document.getElementById("titulo").value;
  const conteudo = document.getElementById("conteudo").value;
  await fetch("noticias.php", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({acao:"adicionar",titulo,conteudo})
  });
  document.getElementById("titulo").value="";
  document.getElementById("conteudo").value="";
  carregarNoticias();
});

async function removerNoticia(index) {
  await fetch("noticias.php", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({acao:"remover",index})
  });
  carregarNoticias();
}
carregarNoticias();

// ============ Aqui entra toda a lógica de render, edição, presenças, ocupação ============
// (copiada do ficheiro antigo para garantir funcionalidade)

// TODO: Inserir toda a lógica render(), guardarAlteracoes(), guardarPresencas(), calcularTaxaOcupacao() ...

// EmailJS
(function(){ emailjs.init({ publicKey:"8jlE16f213Mla1ihS" }); })();

function logout(){ localStorage.removeItem("token"); window.location.href="/login.html"; }
</script>

</body>
</html>
