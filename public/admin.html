<!DOCTYPE html>

<html lang="pt">
<head>
<meta charset="utf-8"/>
<title>Administração</title>
<link href="style.css" rel="stylesheet"/>
<style>
    .agendamento-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      transition: box-shadow 0.3s ease;
    }
    .agendamento-card:hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .agendamento-card button {
      margin-top: 10px;
      margin-right: 8px;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      background-color: #2b7cff;
      color: white;
      cursor: pointer;
    }
    .agendamento-card button:hover {
      background-color: #195ecb;
    }
    .tabs {
      margin-bottom: 1em;
    }
    .tab-button {
      padding: 10px 15px;
      margin-right: 5px;
      border: none;
      background-color: #eee;
      cursor: pointer;
    }
    .tab-button.active {
      background-color: #ccc;
    }
    .tab-content {
      display: none;
      padding: 1em;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    .tab-content.active {
      display: block;
    }
  
.extras { display: none !important; }</style>
  
<style>
.popup-confirmacao {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #4CAF50;
  color: white;
  padding: 30px 40px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  font-size: 1.2rem;
  z-index: 9999;
  text-align: center;
  animation: fadeOut 30s forwards;
}
@keyframes fadeOut {
  0% {opacity: 1;}
  80% {opacity: 1;}
  100% {opacity: 0; display: none;}
}
</style>

<script src="auth.js"></script>
</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">
  <img src="ulsas_logotipo.png" alt="Logotipo" style="height: 40px;">
  <button id="logoutBtn" style="padding: 6px 12px; border-radius: 6px;">Logout</button>
</header>








<script>
  ensureAuthenticated();
  showLogoutIfAuthenticated();
  token = localStorage.getItem("token");
if (!token) {
    window.location.href = "/login.html";
  } else {
    if (!ensureRole("admin")) {
      alert("Acesso restrito a administradores.");
      window.location.href = "/index.html";
    }
  }
</script>
<div class="header">
<img alt="Logotipo ULSAS" class="logo" src="/ulsas_logotipo.png"/>
</div>
<div class="sidebar">
<ul>
<li><a href="index.html">Início</a></li>
<li><a href="agendamentos.html">Agendamentos</a></li>
<li><a href="calendario.html">Calendário</a></li>
<li><a href="salas.html">Salas</a></li>
<li><a href="admin.html">Administração</a></li>
</ul>
</div>
<div class="main-content">
<h1>Administração</h1>
<div style="margin-bottom: 1em;">
  <label for="filtro-data"><strong>Filtrar por data:</strong></label>
  <input id="filtro-data" type="date"/>
  <button onclick="document.getElementById('filtro-data').value=''; renderAgendamentos();">Limpar filtro</button>
</div>
<div class="tabs">
  <button class="tab-button active" data-tab="aprovacao">Aprovado</button>
  <button class="tab-button" data-tab="pendente">Pendente</button>
  <button class="tab-button" data-tab="em_aprovacao">Reservas</button>
  <button class="tab-button" data-tab="concluido">Concluído</button>
  <button class="tab-button" data-tab="definicoes">Definições</button>
</div>
<div class="tab-content active" id="aprovacao"></div>
<div class="tab-content" id="pendente"></div>
<div class="tab-content" id="em_aprovacao"></div>
<div class="tab-content" id="concluido"></div>
<div class="tab-content" id="definicoes"></div>
</div>
</div>
<script>

// Função para renderizar agendamentos nas tabs
async function renderAgendamentos() {
  const aprovacaoDiv = document.getElementById("aprovacao");
  const pendenteDiv = document.getElementById("pendente");
  const emAprovacaoDiv = document.getElementById("em_aprovacao");
  const concluidoDiv = document.getElementById("concluido");

  aprovacaoDiv.innerHTML = "";
  pendenteDiv.innerHTML = "";
  emAprovacaoDiv.innerHTML = "";
  concluidoDiv.innerHTML = "";

  let filtroData = document.getElementById("filtro-data")?.value;
  filtroData = filtroData ? new Date(filtroData) : null;

  try {
    const resp = await fetch("/agendamentos");
    const agendamentos = await resp.json();
    agendamentos.forEach((ag) => {
      // Filtro por data
      if (filtroData) {
        const dataAg = new Date(ag.data);
        if (
          dataAg.getFullYear() !== filtroData.getFullYear() ||
          dataAg.getMonth() !== filtroData.getMonth() ||
          dataAg.getDate() !== filtroData.getDate()
        ) return;
      }
      const card = document.createElement("div");
      card.className = "agendamento-card";
      card.innerHTML = `
        <strong>${ag.evento || ag.nome_evento || ''}</strong><br>
        Requerente: ${ag.requerente || ag.nome || ''}<br>
        Data: ${ag.data || ''}<br>
        Hora: ${ag.hora_inicio || ''} - ${ag.hora_fim || ''}<br>
        Sala: ${ag.sala || ''}<br>
        Participantes: ${ag.participantes || "-"}<br>
        Observações: ${ag.observacoes || "-"}<br>
        Estado: ${ag.estado || ''}
      `;
      if (ag.estado === "Pendente") {
        card.innerHTML += `
          <button onclick="atualizarAgendamento(${ag.id}, 'Aprovado')">Aprovar</button>
          <button onclick="atualizarAgendamento(${ag.id}, 'Rejeitado')">Rejeitar</button>
        `;
        pendenteDiv.appendChild(card);
      } else if (ag.estado === "Aprovado") {
        card.innerHTML += `
          <button onclick="atualizarAgendamento(${ag.id}, 'Pendente')">Tornar Pendente</button>
        `;
        aprovacaoDiv.appendChild(card);
      } else if (ag.estado === "Reservas" || ag.estado === "Em Aprovação") {
        emAprovacaoDiv.appendChild(card);
      } else if (ag.estado === "Concluído") {
        concluidoDiv.appendChild(card);
      }
    });
  } catch (err) {
    console.error("Erro ao carregar agendamentos", err);
  }
}

// Atualizar estado do agendamento
async function atualizarAgendamento(id, estado) {
  await fetch(`/agendamentos/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ estado })
  });
  renderAgendamentos();
}

// Tabs
document.addEventListener('DOMContentLoaded', function () {
  renderAgendamentos();
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      const tab = button.getAttribute('data-tab');
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      button.classList.add('active');
      document.getElementById(tab).classList.add('active');
    });
  });
});

function calcularTaxaOcupacao() {
  const sala = document.getElementById("ocupacao-sala").value;
  const ano = document.getElementById("ocupacao-ano").value;
  
    const mesInicioStr = document.getElementById("mes-inicio").value;
    const mesFimStr = document.getElementById("mes-fim").value;
    const mesInicio = mesInicioStr !== "" ? parseInt(mesInicioStr) : null;
    const mesFim = mesFimStr !== "" ? parseInt(mesFimStr) : null;

  const dia = document.getElementById("ocupacao-dia").value;
  const resultado = document.getElementById("resultado-ocupacao");
  resultado.innerHTML = "";

  if (!ano) {
    resultado.innerHTML = "<p style='color:red;'>Por favor, selecione um ano.</p>";
    return;
  }

  const agendamentos = JSON.parse(localStorage.getItem("agendamentos") || "[]");

  let horasPrevistas = 0;
  let participantesPrevistos = 0;
  let horasEfetivas = 0;
  let participantesEfetivos = 0;

  agendamentos.forEach(ev => {
    const inicio = new Date(ev.start);
    const fim = new Date(ev.end);
    const props = ev.extendedProps || {};

    const anoNum = parseInt(ano);
    
    const diaNum = dia !== "" ? parseInt(dia) : null;

    
const mesmaData = (
  inicio.getFullYear() === anoNum &&
  (mesInicio === null || inicio.getMonth() >= mesInicio) &&
  (mesFim === null || inicio.getMonth() <= mesFim) &&
  (diaNum === null || inicio.getDate() === diaNum)
);


    const salaLower = (props.sala || "").toLowerCase();
    const mesmaSala = (
      sala === "todas" ||
      props.sala === sala ||
      (sala === "hgo" && salaLower.includes("hgo")) ||
      (sala === "sobreda" && salaLower.includes("sobreda"))
    );

    if (mesmaData && mesmaSala) {
      const duracaoHoras = (fim - inicio) / (1000 * 60 * 60);

      if (props.status === "aprovado") {
        horasPrevistas += duracaoHoras;
        participantesPrevistos += parseInt(props.participantes || 0);
      }

      if (props.status === "concluido") {
        horasEfetivas += parseFloat(props.horasEfetivas || 0);
        participantesEfetivos += parseInt(props.participantesEfetivos || 0);
      }
    }
  });

  const horasUteisPorSala = 12;
  let numSalasSelecionadas = 0;

  if (sala === "todas") {
    numSalasSelecionadas = 6;
  } else if (sala === "hgo" || sala === "sobreda") {
    numSalasSelecionadas = 3;
  } else {
    numSalasSelecionadas = 1;
  }

  const totalHorasDisponiveis = horasUteisPorSala * numSalasSelecionadas;

  const taxaHorasTotal = totalHorasDisponiveis ? ((horasPrevistas + horasEfetivas) / totalHorasDisponiveis) * 100 : 0;
  const taxaParticipantesTotal = totalHorasDisponiveis ? ((participantesPrevistos + participantesEfetivos) / (totalHorasDisponiveis * 10)) * 100 : 0;

  resultado.innerHTML = `
    <p><strong>Participantes previstos:</strong> ${participantesPrevistos}</p>
    <p><strong>Participantes efetivos:</strong> ${participantesEfetivos}</p>
    <p><strong>Horas previstas:</strong> ${horasPrevistas.toFixed(2)}</p>
    <p><strong>Horas efetivas:</strong> ${horasEfetivas.toFixed(2)}</p>
    <p><strong>Taxa Ocupação (Horas):</strong> ${taxaHorasTotal.toFixed(1)}%</p>
    <p><strong>Taxa Ocupação (Participantes):</strong> ${taxaParticipantesTotal.toFixed(1)}%</p>
  `;
}

</script>

<!-- Modal Presenças -->
<div id="modal-presencas" class="modal-evento" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999;">
  <div class="modal-evento-content" style="background:#fff; margin:10% auto; padding:20px; width:300px; border-radius:8px;">
    <span class="fechar-modal" onclick="document.getElementById('modal-presencas').style.display='none'" style="float:right; cursor:pointer;">×</span>
    <h3>Registar Presenças</h3>
    <label>Horas Efetivas:<br/>
      <input type="number" step="0.25" min="0" id="horasEfetivas" />
    </label><br/><br/>
    <label>Participantes Efetivos:<br/>
      <input type="number" min="0" id="participantesEfetivos" />
    </label><br/><br/>
    <button onclick="guardarPresencas()">Guardar</button>
  </div>
</div>


  <button id="logout-btn" onclick="logout()">Logout</button>
  <style>
    #logout-btn {
      position: fixed;
      top: 15px;
      right: 20px;
      padding: 8px 14px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 2000;
      display: none;
    }
  </style>
  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "/login.html";
    } else {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const now = Math.floor(Date.now() / 1000);
        if (payload.exp < now) {
          localStorage.removeItem("token");
          window.location.href = "/login.html";
        } else {
          const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) logoutBtn.style.display = "block";
        }
      } catch (e) {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
    }
  </script>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  (function(){
      emailjs.init({
        publicKey:("8jlE16f213Mla1ihS"),
      });
   })();

  function enviarEmailConfirmacao(ev) {
    const props = ev.extendedProps || {};

    if (!props.emailReq) {
      console.warn("Email não definido no agendamento:", ev);
      return;
    }

    const data = new Date(ev.start);
    const dataStr = data.toLocaleDateString("pt-PT");
    const hora = data.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) +
                 " - " + new Date(ev.end).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    emailjs.send("service_osoiajl", "template_oizzjid", {
      nome: props.nomeReq || "Utilizador",
      email: props.emailReq,
      data: dataStr + " " + hora,
      evento: ev.title
    }).then(function(response) {
      console.log("Email enviado com sucesso!", response.status, response.text);
      
const popup = document.getElementById("popupEmailConfirmado");
popup.style.display = "block";
setTimeout(() => {
  popup.style.display = "none";
}, 5000);

    }, function(error) {
      console.error("Erro ao enviar email:", error);
      alert("Erro ao enviar email. Verifica a consola.");
    });
  }
</script>


<div class="popup-confirmacao" id="popupEmailConfirmado">
  <p>Email enviado com sucesso!</p>
</div>
</body>

</html>


