<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<title>Administra√ß√£o</title>
<link href="style.css" rel="stylesheet"/>

<style>
  /* estilos existentes */
  .agendamento-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 15px; transition: box-shadow 0.3s ease; }
  .agendamento-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
  .agendamento-card button { margin-top: 10px; margin-right: 8px; padding: 6px 10px; border: none; border-radius: 5px; background-color: #2b7cff; color: white; cursor: pointer; }
  .agendamento-card button:hover { background-color: #195ecb; }
  .tabs { margin-bottom: 1em; }
  .tab-button { padding: 10px 15px; margin-right: 5px; border: none; background-color: #eee; cursor: pointer; }
  .tab-button.active { background-color: #ccc; }
  .tab-content { display: none; padding: 1em; border: 1px solid #ddd; background: #fafafa; }
  .tab-content.active { display: block; }
  .extras { display: none !important; }

  /* Submenu defini√ß√µes */
  .subtabs { margin-bottom: 1em; }
  .subtab-button { padding: 8px 12px; margin-right: 5px; border: none; background-color: #eee; cursor: pointer; }
  .subtab-button.active { background-color: #ccc; }
  .tab-subcontent { display: none; margin-top: 1em; }
  .tab-subcontent.active { display: block; }

  .noticia { background: #f9f9f9; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
  .noticia button { margin-top: 5px; background: #e74c3c; color: white; }
</style>

<script src="auth.js"></script>
</head>
<body>
<header style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">
  <img src="ulsas_logotipo.png" alt="Logotipo" style="height: 40px;">
  <button id="logoutBtn" style="padding: 6px 12px; border-radius: 6px;">Logout</button>
</header>

<script>
  ensureAuthenticated();
  showLogoutIfAuthenticated();
  token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "/login.html";
  } else {
    if (!ensureRole("admin")) {
      alert("Acesso restrito a administradores.");
      window.location.href = "/index.html";
    }
  }
</script>

<div class="sidebar">
<ul>
<li><a href="index.html">In√≠cio</a></li>
<li><a href="agendamentos.html">Agendamentos</a></li>
<li><a href="calendario.html">Calend√°rio</a></li>
<li><a href="salas.html">Salas</a></li>
<li><a href="admin.html">Administra√ß√£o</a></li>
</ul>
</div>

<div class="main-content">
<h1>Administra√ß√£o</h1>
<div style="margin-bottom: 1em;">
<label for="filtro-data"><strong>Filtrar por data:</strong></label>
<input id="filtro-data" onchange="render()" type="date"/>
<button onclick="document.getElementById('filtro-data').value=''; render();">Limpar filtro</button>
</div>

<div class="tabs">
  <button class="tab-button active" data-tab="aprovacao">Aprovado</button>
  <button class="tab-button" data-tab="pendente">Pendente</button>
  <button class="tab-button" data-tab="em_aprovacao">Reservas</button>
  <button class="tab-button" data-tab="concluido">Conclu√≠do</button>
  <button class="tab-button" data-tab="definicoes">Defini√ß√µes</button>
</div>

<div class="tab-content active" id="aprovacao"></div>
<div class="tab-content" id="pendente"></div>
<div class="tab-content" id="em_aprovacao"></div>
<div class="tab-content" id="concluido">
  <label><strong>Filtrar por sala:</strong></label>
  <select id="filtro-concluido" onchange="render()">
    <option value="todas">Todas as salas</option>
    <option value="hgo">Salas HGO</option>
    <option value="sobreda">Salas Sobreda</option>
  </select>
  <div id="lista-concluido"></div>
</div>

<!-- Defini√ß√µes com submenu -->
<div class="tab-content" id="definicoes">
  <h2>Defini√ß√µes</h2>
  <div class="subtabs">
    <button class="subtab-button active" data-subtab="ocupacao">üìä Taxa de Ocupa√ß√£o</button>
    <button class="subtab-button" data-subtab="noticias">üì∞ Gest√£o de Not√≠cias</button>
  </div>

  <!-- Subtab Ocupa√ß√£o (mant√©m o que j√° tens) -->
  <div class="tab-subcontent active" id="ocupacao">
    <!-- (mantive o teu c√≥digo de taxa de ocupa√ß√£o) -->
    <!-- ... -->
    <div id="resultado-ocupacao" style="margin-top: 1em;"></div>
  </div>

  <!-- Subtab Not√≠cias -->
  <div class="tab-subcontent" id="noticias">
    <h3>Adicionar Not√≠cia</h3>
    <form id="form-noticia">
      <input type="text" name="titulo" placeholder="T√≠tulo" required>
      <textarea name="conteudo" placeholder="Conte√∫do" required></textarea>
      <button type="submit">Publicar</button>
    </form>
    <h3>Not√≠cias Publicadas</h3>
    <div id="lista-admin-noticias"></div>
  </div>
</div>
</div>

<script>
// Subtabs dentro de defini√ß√µes
document.addEventListener("DOMContentLoaded", () => {
  const subButtons = document.querySelectorAll('[data-subtab]');
  const subContents = document.querySelectorAll('.tab-subcontent');
  subButtons.forEach(button => {
    button.addEventListener('click', () => {
      const subtab = button.getAttribute('data-subtab');
      subButtons.forEach(btn => btn.classList.remove('active'));
      subContents.forEach(content => content.classList.remove('active'));
      button.classList.add('active');
      document.getElementById(subtab).classList.add('active');
    });
  });
});

// Gest√£o de not√≠cias
document.getElementById("form-noticia")?.addEventListener("submit", async function(e) {
  e.preventDefault();
  const token = localStorage.getItem("token");
  if (!token) { alert("Precisa estar autenticado como administrador."); return; }
  const formData = new FormData(this);
  const response = await fetch("noticias.php", { method: "POST", headers: { "Authorization": "Bearer " + token }, body: formData });
  const result = await response.text();
  alert(result);
  carregarNoticiasAdmin();
});

async function carregarNoticiasAdmin() {
  try {
    const response = await fetch("noticias.json");
    const noticias = await response.json();
    const container = document.getElementById("lista-admin-noticias");
    container.innerHTML = "";
    noticias.forEach((noticia, index) => {
      const div = document.createElement("div");
      div.classList.add("noticia");
      div.innerHTML = `<p><strong>${noticia.titulo}</strong>: ${noticia.conteudo}</p>
                       <button onclick="removerNoticia(${index})">‚ùå Remover</button>`;
      container.appendChild(div);
    });
  } catch (e) {
    console.error("Erro ao carregar not√≠cias admin", e);
  }
}
carregarNoticiasAdmin();

async function removerNoticia(index) {
  const token = localStorage.getItem("token");
  if (!token) { alert("Precisa estar autenticado como administrador."); return; }
  const formData = new FormData();
  formData.append("remover", index);
  const response = await fetch("noticias.php", { method: "POST", headers: { "Authorization": "Bearer " + token }, body: formData });
  const result = await response.text();
  alert(result);
  carregarNoticiasAdmin();
}
</script>
</body>
</html>
