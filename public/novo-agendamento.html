<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8"/>
  <title>Novo Agendamento</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="auth.js"></script>
</head>
<body>
  <div class="sidebar">
    <ul>
      <li><a href="index.html">Início</a></li>
      <li><a href="agendamentos.html">Agendamentos</a></li>
      <li><a href="calendario.html">Calendário</a></li>
      <li><a href="salas.html">Salas</a></li>
      <li><a href="admin.html">Administração</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>Formulário de Agendamento</h1>
    <form id="agendamento-form">
      <fieldset>
        <legend><strong>Requerente</strong></legend>
        <label>Número Mecanográfico:<input type="text" name="num_mec" required></label>
        <label>Nome:<input type="text" name="nome" required></label>
        <label>Serviço:<input type="text" name="servico" required></label>
        <div class="linha">
          <label>Email:<input type="email" name="email" required></label>
          <label>Contacto:<input type="tel" name="contacto" required placeholder="912 345 678"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend><strong>Evento</strong></legend>
        <label>Sala:<select name="sala" required>
          <option value="">-- Selecione --</option>
          <optgroup label="HGO">
            <option>HGO - Sala Almada</option>
            <option>HGO - Sala Garcia de Orta</option>
            <option>HGO - Sala Tejo</option>
            <option>HGO - Sala Almada + Garcia de Orta</option>
          </optgroup>
          <optgroup label="CF Sobreda">
            <option>CF Sobreda - Auditório Dr. Luís Amaro</option>
            <option>CF Sobreda - Sala Sado</option>
            <option>CF Sobreda - Sala Tejo</option>
          </optgroup>
          <optgroup label="CF Amora">
            <option>CF Amora - Sala Amora</option>
          </optgroup>
        </select></label>
        <div class="linha">
          <label>Nome do Evento:<input type="text" name="evento" required></label>
          <label>N.º de Participantes:<input type="number" name="participantes"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend><strong>Data e Hora</strong></legend>
        <label>Data:<input type="date" name="data" required></label>
        <div class="linha">
          <label>Hora de Início:<input type="time" name="hora_inicio" required></label>
          <label>Hora de Fim:<input type="time" name="hora_fim" required></label>
        </div>
      </fieldset>

      <fieldset>
        <legend><strong>Recursos Necessários</strong></legend>
        <label><input type="checkbox" name="recursos" value="Limpeza"> Limpeza</label>
        <label><input type="checkbox" name="recursos" value="Catering/Coffee-Break"> Catering / Coffee-Break</label>
        <label><input type="checkbox" name="recursos" value="Segurança"> Segurança</label>
        <label><input type="checkbox" name="recursos" value="Material Clínico"> Material Clínico</label>
        <label><input type="checkbox" name="recursos" value="Projetor"> Projetor</label>
        <label><input type="checkbox" name="recursos" value="Computador"> Computador</label>
        <label><input type="checkbox" name="recursos" value="Som"> Som</label>
      </fieldset>

      <fieldset>
        <legend><strong>Observações</strong></legend>
        <textarea name="observacoes" rows="5"></textarea>
      </fieldset>

      <button type="submit" class="botao-novo">Submeter</button>
    </form>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    ensureAuthenticated();
    showLogoutIfAuthenticated();

    function mostrarToast(msg, erro=false) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.className = "toast mostrar" + (erro ? " erro" : "");
      setTimeout(()=> toast.className="toast", 4000);
    }

    document.getElementById("agendamento-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const dados = Object.fromEntries(formData.entries());
      dados.recursos = formData.getAll("recursos");

      try {
        const token = localStorage.getItem("token");
        const resposta = await fetch("/api/agendamentos", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(dados)
        });
        if (resposta.ok) {
          mostrarToast("Agendamento submetido com sucesso!");
          setTimeout(()=> window.location.href = "agendamentos.html", 1500);
        } else {
          const erro = await resposta.json();
          mostrarToast("Erro: " + (erro.message || "Não foi possível gravar."), true);
        }
      } catch (err) {
        mostrarToast("Erro de ligação ao servidor.", true);
      }
    });
  </script>
</body>
</html>

